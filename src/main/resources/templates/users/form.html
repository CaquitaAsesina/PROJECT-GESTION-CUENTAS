<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title th:text="${user.id == null ? 'Nuevo Usuario' : 'Editar Usuario'}">Formulario Usuario</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* Navbar personalizado */
        .custom-navbar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        /* Animación del formulario */
        .form-container {
            animation: slideIn 0.5s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Efecto en inputs al enfocar */
        .form-control:focus,
        .form-select:focus {
            box-shadow: 0 0 0 0.25rem rgba(102, 126, 234, 0.25);
            border-color: #667eea;
        }
    </style>
</head>

<body>

    <!-- NAVBAR -->
    <nav class="navbar navbar-expand-lg navbar-dark custom-navbar mb-4">
        <div class="container-fluid">
            <a class="navbar-brand" th:href="@{/}">
                <i class="fas fa-layer-group"></i>
                <strong>Sistema de Cuentas</strong>
            </a>

            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>

            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" th:href="@{/}">
                            <i class="fas fa-home"></i> Inicio
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" th:href="@{/users}">
                            <i class="fas fa-users"></i> Usuarios
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" th:href="@{/gmails}">
                            <i class="fas fa-envelope"></i> Correos
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" th:href="@{/accounts}">
                            <i class="fas fa-id-card"></i> Cuentas
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container">

        <!-- BREADCRUMB -->
        <nav aria-label="breadcrumb" class="mb-3">
            <ol class="breadcrumb">
                <li class="breadcrumb-item">
                    <a th:href="@{/}"><i class="fas fa-home"></i> Inicio</a>
                </li>
                <li class="breadcrumb-item">
                    <a th:href="@{/users}"><i class="fas fa-users"></i> Usuarios</a>
                </li>
                <li class="breadcrumb-item active" aria-current="page">
                    <span th:text="${user.id == null ? 'Nuevo' : 'Editar'}">Formulario</span>
                </li>
            </ol>
        </nav>

        <div class="row justify-content-center">
            <div class="col-md-8">

                <!-- CARD DEL FORMULARIO -->
                <div class="card shadow-lg form-container">
                    <div class="card-header bg-primary text-white">
                        <h4 class="mb-0">
                            <i th:class="${user.id == null ? 'fas fa-user-plus' : 'fas fa-user-edit'}"></i>
                            <span th:text="${user.id == null ? 'Nuevo Usuario' : 'Editar Usuario'}">
                                Formulario
                            </span>
                        </h4>
                    </div>

                    <div class="card-body">

                        <!-- MENSAJES DE ERROR -->
                        <div th:if="${error}" class="alert alert-danger alert-dismissible fade show">
                            <i class="fas fa-exclamation-triangle"></i>
                            <strong>Error:</strong> <span th:text="${error}">Error</span>
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        </div>

                        <!-- FORMULARIO -->
                        <form th:action="${user.id != null ? '/users/update/' + user.id : '/users'}" th:object="${user}"
                            method="post">

                            <!-- CAMPO: ADMINISTRADOR -->
                            <div class="mb-4">
                                <label for="administrador" class="form-label">
                                    <i class="fas fa-user text-primary"></i>
                                    <strong>Nombre de Administrador</strong>
                                    <span class="text-danger">*</span>
                                </label>

                                <input type="text" class="form-control form-control-lg" th:field="*{administrador}"
                                    placeholder="Ej: admin1, usuario123" required minlength="3" maxlength="20">

                                <div class="form-text">
                                    <i class="fas fa-info-circle"></i>
                                    Entre 3 y 20 caracteres. Debe ser único en el sistema.
                                </div>
                            </div>

                            <!-- CAMPO: CUENTAS -->
                            <div class="mb-4">
                                <label for="cuentas" class="form-label">
                                    <i class="fas fa-hashtag text-success"></i>
                                    <strong>Número de Cuentas</strong>
                                </label>

                                <div class="input-group input-group-lg">
                                    <span class="input-group-text">
                                        <i class="fas fa-calculator"></i>
                                    </span>
                                    <input type="number" class="form-control" th:field="*{cuentas}" min="0"
                                        placeholder="0">
                                </div>

                                <div class="form-text">
                                    <i class="fas fa-info-circle"></i>
                                    Este campo se actualiza automáticamente al crear cuentas.
                                </div>
                            </div>

                            <!-- CAMPO OCULTO: ID -->
                            <input type="hidden" th:if="${user.id != null}" th:field="*{id}">

                            <!-- SEPARADOR -->
                            <hr class="my-4">

                            <!-- BOTONES DE ACCIÓN -->
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <a th:href="@{/users}" class="btn btn-secondary btn-lg">
                                        <i class="fas fa-arrow-left"></i> Cancelar
                                    </a>
                                </div>

                                <div>
                                    <button type="submit" class="btn btn-success btn-lg">
                                        <i th:class="${user.id == null ? 'fas fa-save' : 'fas fa-check'}"></i>
                                        <span th:text="${user.id == null ? 'Crear Usuario' : 'Guardar Cambios'}">
                                            Guardar
                                        </span>
                                    </button>
                                </div>
                            </div>
                        </form>

                        <!-- INFORMACIÓN ADICIONAL (solo en edición) -->
                        <div th:if="${user.id != null}" class="mt-5">
                            <hr>

                            <h6 class="text-muted mb-3">
                                <i class="fas fa-info-circle"></i> Información del Registro
                            </h6>

                            <div class="row">
                                <div class="col-md-4">
                                    <div class="card bg-light">
                                        <div class="card-body text-center">
                                            <small class="text-muted d-block">ID</small>
                                            <strong class="fs-4" th:text="${user.id}">1</strong>
                                        </div>
                                    </div>
                                </div>

                                <div class="col-md-4">
                                    <div class="card bg-light">
                                        <div class="card-body text-center">
                                            <small class="text-muted d-block">Creado</small>
                                            <strong th:text="${#temporals.format(user.fechaRegistro, 'dd/MM/yyyy')}">
                                                01/01/2025
                                            </strong>
                                            <br>
                                            <small th:text="${#temporals.format(user.fechaRegistro, 'HH:mm')}">
                                                10:30
                                            </small>
                                        </div>
                                    </div>
                                </div>

                                <div class="col-md-4">
                                    <div class="card bg-light">
                                        <div class="card-body text-center">
                                            <small class="text-muted d-block">Actualizado</small>
                                            <strong
                                                th:text="${#temporals.format(user.fechaActualizacion, 'dd/MM/yyyy')}">
                                                01/01/2025
                                            </strong>
                                            <br>
                                            <small th:text="${#temporals.format(user.fechaActualizacion, 'HH:mm')}">
                                                15:45
                                            </small>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Enlaces a sus cuentas y correos -->
                            <div class="mt-4">
                                <div class="alert alert-info">
                                    <strong><i class="fas fa-link"></i> Accesos Rápidos:</strong>
                                    <div class="mt-2">
                                        <a th:href="@{/gmails/user/{id}(id=${user.id})}"
                                            class="btn btn-sm btn-success me-2">
                                            <i class="fas fa-envelope"></i> Ver sus Correos Gmail
                                        </a>
                                        <a th:href="@{/accounts/user/{id}(id=${user.id})}" class="btn btn-sm btn-info">
                                            <i class="fas fa-id-card"></i> Ver sus Cuentas
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- AYUDA -->
                <div class="card mt-4 shadow-sm">
                    <div class="card-body bg-light">
                        <h6 class="text-muted mb-3">
                            <i class="fas fa-question-circle"></i> Ayuda
                        </h6>
                        <ul class="mb-0">
                            <li><strong>Nombre de Administrador:</strong> Debe ser único. Se usa para identificar al
                                usuario.</li>
                            <li><strong>Número de Cuentas:</strong> Se actualiza automáticamente cuando creas cuentas
                                asociadas.</li>
                            <li>Los campos marcados con <span class="text-danger">*</span> son obligatorios.</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- JavaScript de validación -->
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const form = document.querySelector('form');

            form.addEventListener('submit', function (event) {
                const administrador = document.querySelector('input[name="administrador"]').value.trim();

                // Validación de longitud
                if (administrador.length < 3) {
                    event.preventDefault();
                    alert('El nombre de administrador debe tener al menos 3 caracteres');
                    return false;
                }

                if (administrador.length > 20) {
                    event.preventDefault();
                    alert('El nombre de administrador no puede exceder 20 caracteres');
                    return false;
                }

                // Validación de caracteres especiales (opcional)
                const regex = /^[a-zA-Z0-9_-]+$/;
                if (!regex.test(administrador)) {
                    if (!confirm('El nombre contiene caracteres especiales. ¿Desea continuar?')) {
                        event.preventDefault();
                        return false;
                    }
                }

                return true;
            });
        });
    </script>
</body>

</html>

<!-- 
===== UBICACIÓN DEL ARCHIVO =====
src/main/resources/templates/users/form.html

===== FLUJO DE VINCULACIÓN DE DATOS =====

CREAR NUEVO USUARIO:
1. GET /users/new → showCreateForm()
2. Controller crea UserDTO vacío: new UserDTO()
3. Agrega al Model: model.addAttribute("user", userDTO)
4. Retorna: "users/form"
5. Thymeleaf renderiza form.html
6. Campos vacíos: th:field="*{administrador}" → value=""
7. Usuario llena el formulario
8. Clic en "Guardar"
9. POST /users
10. @ModelAttribute convierte datos del form a UserDTO
11. Controller llama userService.createUser(userDTO)

EDITAR USUARIO EXISTENTE:
1. GET /users/edit/5 → showEditForm(5)
2. Controller busca usuario: userService.getUserById(5)
3. Encuentra UserDTO con: id=5, administrador="admin1", cuentas=3
4. Agrega al Model: model.addAttribute("user", userDTO)
5. Retorna: "users/form"
6. Thymeleaf renderiza el MISMO form.html
7. Campos prellenados: th:field="*{administrador}" → value="admin1"
8. Usuario modifica los datos
9. Clic en "Actualizar"
10. POST /users/update/5
11. Controller llama userService.updateUser(5, userDTO)

===== @ModelAttribute EXPLICADO =====

HTML enviado:
POST /users
administrador=admin1&cuentas=5

Spring recibe:
@ModelAttribute("user") UserDTO userDTO

Spring hace automáticamente:
UserDTO userDTO = new UserDTO();
userDTO.setAdministrador("admin1");
userDTO.setCuentas(5);

===== th:field vs th:value =====

th:field="*{administrador}":
✅ Genera: id, name, value automáticamente
✅ Vinculación bidireccional
✅ Usa el th:object del form
Resultado: <input id="administrador" name="administrador" value="admin1">

th:value="${user.administrador}":
❌ Solo genera el value
❌ Debes poner id y name manualmente
Resultado: <input value="admin1"> (falta id y name)

===== VENTAJAS DE THYMELEAF FORMS =====
✅ Vinculación automática de datos
✅ Pre-llenado de formularios para edición
✅ Validación integrada con Bean Validation
✅ Tokens CSRF automáticos (seguridad)
✅ Manejo de errores de validación
-->